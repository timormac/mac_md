

# 数据湖论文

http://cidrdb.org/cidr2021/papers/cidr2021_paper17.pdf

```sql
#个人理解
数据湖论文定义:低成本，直接访问数据的管理系统。可更好的支持多系统

数据湖是为了解决超大型企业下，不同部门数据孤岛的问题。例如 抖音，外卖，快递等app都在一个集团下，就是数据孤岛。
然后不同部门用的是不同仓库架构，有自己的数据存储模式，无法被其他仓库系统支持访问。

数据湖用orc,parquet主流数据存，所有其他部门的数仓，都是通过数据湖的外部表来获取数据，这样数据就都在一起了。
并且数据仓库不好的支持算法，机器学习。数据湖开往原文件访问，这是对机器学习最好的支持
```

#### 数据湖背景(论文)

```sql
据架构通常存在以下四个问题：
#可靠性
保持数据湖和数据仓库的一致性既困难又昂贵。需要持续的工程来在两个系统之间交换数据，并使其可用于高性能决策支持和BI。每个ETL步骤也都有导致失败或引I入降低数据质量的错误的风险，例如，由于数据湖和仓库引擎之间的细微差异。过时的数据。与数据湖的数据相比，仓库中的数据是陈旧的，加载新数据通常需要几天的时间。与第一代分析系统相比，这是一个倒退，在第一代分析系统中，新的操作数据可以立即用于查询。根据DimensionalResearch和Fivetran的一项调查，86%的分析师使用过时的数据，62%的分析师每月多次等待工程资源[47]。对高级分析的有限支持。企业希望利用他们的仓储数据提出预测性问题，例如，“我应该向哪些客户提供折扣？”尽管有很多关于机器学习和数据管理融合的研究

#还有其他的没有截取过来

为了解决这些问题，第二代数据分析平台开始将所有原始数据卸载到数据湖中：具有文件API的低成本存储系统，以通用且通常开放的文件格式保存数据，例如Apache Parquet和ORC[8,9]。这种方法始于Apache Hadoop运动[5]，使用Hadoop文件系统（HDFS）进行廉价存储。数据湖是一种读时模式（schema-on-read）架构，它能够以低成本灵活地存储任何数据，但另一方面，也解决了数据的问题。本文在知识共享署名许可（http://creativecommons.org/licenses/by/3.0/）下发布。第十一届创新数据系统研究年会（CIDR21），2021年1月11-15日，在线。，但没有一个领先的机器学习系统，如TensorFlow、PyTorch和xGBoost，能在仓库上很好地工作。与提取少量数据的BI查询不同，这些系统需要使用复杂的非sql代码处理大型数据集。通过ODBC/JDBC读取这些数据效率很低，而且没有办法直接访问内部数据


```



#### 目的

```sql
1 越来越多的非结构化数据,数据仓库无法存储和查询，数据仓库没法存非结构化数据,因为没法通过表的形式，区分不同视频。一个视频就是一个文件


#这里有疑问？数据湖难道每次要临时传输吗？
2 计算和存储耦合到本地？？？？计算和存储分开？？怎么分开的

3 下游对接数据仓库,数据仓库数据来源于湖？？？？
？？
4 更廉价的存储
数据仓库是写时模式schema-on-write,数据糊是schema on read 

原本架构数据库系统到数据仓库，数据湖为：数据库系统到数据湖到数据仓库

#对接机器学习等不合理
当前机器学习等系统没法在数仓上效率的工作，与少量BI查询不同，机器学习要大量数据集，如何以sql的形式查询效率太低，
最好的办法是，对这些系统直接开放式直接访问数据，是最好的支持

#数据仓库无法有效对接所有其他系统
不同仓库会把数据锁定专有格式，比如mongo等。
目前的标准开放数据格式parquet和orc格式大家都支持，数据湖用这种，方便数据迁移，开发其他系统

#？？这里疑问，不同数据仓库etl处理后的数据
数据湖数据都为parquet和orc,目前所有数仓系统都支持，这2种数据的外部表支持
也就是说我一个数据湖可以为多个不同系统的数据仓库当数据源，这样也解决了，同sql在不同系统的语义有差别，造成数据会错乱的问题。

```

数据湖



# 数仓建模规范编写

为了解决表混乱，中间表重复，各个人物独立，缺乏规范，口径不一致，取数成本高，重新更新数仓设计

分层规范，表命名规范(每层命名规范不同)，表设计规范(储存方式,压缩,内部部表,声明周期,分区分桶)，层级调用规范，表存储更新策略规范，分区分桶规范，字段命名规范，业务划分规范



表命名  分层-业务-数据来源-(库)表名-分区-更新方式-生命周期

  ods_user_mysql_user_userinfo_ds_full_365d

# 数仓意义

提供数据支持是一方面

通过数据提出预测性问题：向哪些用户提供折扣

数仓必须解决的问题是:数据质量，数据准确性 。随着任务变多。

有的代码逻辑有问题，没法发现，业务人员没法看出来，算法和机器学习那种，才能检查出来数据对不上

因为会对多少数据，进行逻辑计算。



# 数仓工作

1 脚本编写，规范调度脚本，脚本之间的依赖关系，血缘依赖

2  数仓业务区域划分

​		商品模块(商品上架，合同，签订商家，库存等)

​		会员服务(积分，优惠券等)

3  优化

   血缘依赖，脚本依赖，分层架构优化，资源优化,代码优化,数据地图，权限管理

  表使用频次，脚本用到的哪些表的频率高(这样可以优化数仓模型),如何实现待做

  比如dwd没有覆盖到的数据，直接从ods取就说明数仓模型不好。如果大部分ads数据能从dws出，说明设计合理

 若大部分从dwd出，说明设计不合理。需要看具体哪些哪些ads人物从dwd出的，因为有些临时



#### 数据治理

数据地图:搜索表名 , 表最后一次更新时间，表的job任务代码 , job任务时间排序，成功任务，报错任务，超时任务的概览地图查看

血缘关系:表血缘，字段血缘

数据字典 :  表被使用次数(命中率)，表使用记录

表权限管理：那些人可读可写,分层，分域，分表。可以整层权限，域权限，表权限



#### 数据质量管理

脏数据处理。

业务数据的脏数据来源

业余逻辑有的字段没有落，后端偷懒。

特殊情况出现的bug，业务人员误操作。

特别情况，比如珍珠棒门票，是没有商户信息的，没有相关其他信息



不规则数据处理，时间格式不规范。有的一些历史表时间不规范等。统一格式



业余数据本身不规范，一个商品排除isdelet后，还是有多条数据，后端代码他们只拿一条。不过我们不知道只能慢慢去查验。



同一和sql平时不丢数据，倒是某一天多数据或者，丢数据了。一般很久之前的商品模型，然后用户某天用了，平时发现不到问题。这种模型漏掉了，平时测不出问题，当时写逻辑问后端时，后端也不知道



质量管理包括:

1数据字段是否有丢失。



2不同商品表的类似字段数据格式是否统一，

比如日期格式，isdeleted字段，不同业余人员写的，他们自己代码自己处理。但是不同人之间表同字段可能格式不同。

比如商品维护人员，有人落的是自增I’d有人落的是人员I’d。所以统一格式



3 条数是否发生变动，丢失，变多

变多，就是同一个I’d多条，前面提到了，业余自己拿一条，我们不知道。还有酒店预约，改期，多天核销表。

少数据，业余人员清洗表字段数据时，比如cram新后台，把字段更新成新的cram。历史数据有人没清洗，几年前的。最后丢数据了



4数据检验，条数对不对，总金额对不对，和和业余表



5 口径一致，当数据仓库，很复杂时，当有的业余需求的时候，看到这个数据某个表有，用了以后发现，和要的口径不同。统一口径



如何解决爱你高效的日常开发管理质量，要想一下。



最好是开发一个功能。在每个hql 变量中，检验目标表条数和哪个条数相同，然后读取脚本时，自动解析，添加质量管理。

脚本配置字段范围，也是脚本检验查sql生成检验sql，然后将检验结果统一放入一个表中。

查询，有条的话，发送给负责人。



6数据存储周期



这个角色的要求实在太多，需要懂各公司现存业务，能理清公司内部乱七八糟系统的乱七八糟东西，协调业务人员和it的关系



#### 任务执行规范

不允许跨多层表取数据， 不允许从ods层取数据



# 具体实现

#### 概论

#### 表分类

用户的周期:下单，购买支付，发卡，预约，使用核销,商家结算

表分类:维度表和事实表。

维度表:由平台提供的数据,不会随着用户购买使用周期而产生数据的表

​		用户方面：用户表，会员等级表，客户表

​		商品方面：商品表，类型表，商家表，合同表，库存



事实表会根据用户购买使用行为而产生变化数据的表单，购买支付，发卡，预约，使用核销,商家结算等相关表。



#### 分层逻辑以及理念

为了执行sql的便捷以及数据的复用性，表模型和传统数据库建模有所区别，传统的满足3范式为了保持数据一致性，节省空间。

数仓为了数据重复利用，以及sql执行速度，减少表的join，会把一些关联的主键放到表中冗余，以及冗余一些常用字段。

例如:商品表中原本只有合同id，把通过合同表相关的商家id和维护bd的主键放到商品表中，并且冗余一些字段，避免后续需要获取维护bd时，先关联合同，再关联维护bd等。



分层ods,dim(dimension) ,dwd(data warehouse detail) ,dws(data warehouse summary) ,dwt,ads(application data service)

ods层 ：

​		不做数据处理， 建表的时候执行压缩和列存parquet存储

​		维度表每日分区全量，保留历史状态

​		事实表:  分区增量，  只新增的用增量,  新增及    变化的用也是增量 （对于数据规模小的可以每日直接更新覆盖）



dim层： 

​		存放维度表

​		商品表添加关联主键，合同编号，维护人员，商家， 

​		冗余哪些字段，具体看需求自己总结



dwd层: 

​        存放事实表

​		数据清洗:一些字段补全(不规范,自己拿),日期时间戳数据统一格式,手机号加密，null和空字段转换等

​		划分主题域:交易域，ugc域(评论收藏),流量域，用户域(注册，登录) 

​		操作冗余一些关联主键,常用字段.比如核销与结算表容易订单号，而不用先关联预约再找券再找订单

​		冗余哪些字段，具体看需求自己总结，以及预留。需要了解比如财务有哪些方面需求,合理设计



dws:

​		



#### 同步规则逻辑

















#### 项目实现细节

#### 同步规则

每日全量（分区重复）：小表每日一份，保存历史状态

每日全量（不分区）：数据量大的业务表

每日增量（分区）：

数据量大的业务表，业务同步的时候使用新增导入，这样数据小，到入快。

对于状态发生变化的数据，找出变化时间是今天，然后关联替换到hdfs上的表，不过要洗数据。







#### 命名规则

dim-库名-表名-分区/更新间隔/全量   dim-product-dsf



层级-主题域-库命-表名-分区及更新间隔  dwd-user-trade-user_buy_name-ds

dwd-主题域-数据库名-表名-ds(ms)

ds和ms 表示是否为分区表，如果为分区表，分区字段是什么，分区间隔为多少



#### 数据划分

维度表是什么，由平台提供的数据

​		用户方面：用户表，会员等级表，客户表

​		商品方面：商品表，类型表，商家表，合同表，库存



事实表由用户行为产生

交易方面：订单，衍生出的：支付相关表，退款相关，核销相关，优惠券使用情况

核销方面:  会员卡使用,券核销

预约方面: 酒店预约

反馈相关：评价，ugc等







#### ODS

数据不动，只保持增量或者全量导入的区别。

#### DIM

商品表里会放很多主键，通过表再找表的，都会去把主键放进去，确保想要的数据能一次关联拿到

比如合同编号，并冗余经常用的商品数据。

冗余主键，签约员工，合同编号，所属的多级分类，签约客户id

处理：对商品做数据清洗，表小，要没日全量，保持历史状态。

比如商品库存表，用每日全量，能获取库存历史状态，商品负责人，维护人。



用户账户余额表，商品库存表，这种都要每日全量，不如某一天产品要这一个月内，每天所有账户的余额，

或者某些商品这一周内每天的库存，只能通过现有的库存通过加减每天的记录来逆推。



包括的表：商品信息，合同，员工，商家客户信息表



#### DWD（主题域）

各种主键，通过表找表的主键都拿到。保证相关表能关联一次拿到

比如券，关联卡，再关联订单表这。

冗余字段，订单流水id，优惠券表id

还有一些自己生成的字段，比如订单表里加入，最后使用日期，是否完结使用（因为有多次卡或买多分），

来计算用户核销周期。核销了才算彻底的入账。



处理：对数据做数据清洗，缺失字段补全，空字段补全之类的，冗余常用字段，

用户地区，会员等级，商品类型 ，支付渠道，下单渠道，经常用到的字段。



主题域的作用，通过指标字段，能知道用到哪些主题域的表，不用从全表中去筛选。



（已解决看下方）

不过当时从mysql到入的时候命名就带trade,product等字段，为什么还要主题域名。



主题域和表命不冲突，因为有时候数据库的库名太分散

比如hotel库，passcard库，在数据域里面都是商品域的，不够在mysl里是库命是分开的



方入的表：订单表，发券，核销，商家结算，退款

附属表有红包记录表，支付流水





#### DWS

按用户当日汇总

商品当日汇总

流量区域当日汇总

具体字段需要看业务需求，比如某个大品类售卖多少，某种售卖方式卖了多少

#### DWT

按用户汇总，统计用户自注册依赖数据，有这个表对一些总的统计数据，会很容易获得。

用户下单次数，支付次数，使用优惠券次数，渠道次数



按商品汇总

某商品被下单次数，被购买次数，推广渠道各自售卖数量



指标推广渠道收益占比



看具体公司需求，有指标需要用的相关的多做这一层。

比如要近期最近1年内上线，半年内没上线的人。